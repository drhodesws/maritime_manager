{% extends 'base.html' %}

{% block content %}
    <div class="header">
        <h1>Edit Time Entry</h1>
        <p>Modify the details of this time entry.</p>
    </div>
    <div style="max-width: 600px; margin: 20px auto; padding: 0;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p style="color: {{ 'green' if category == 'success' else 'red' }};">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <table class="timebook-form-table">
                <tbody>
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="employee">Employee:</label>
                                {{ form.employee(class_="form-control", disabled=session['role'] != 'admin') }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="time_date">Date:</label>
                                {{ form.time_date(class_="form-control") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="start_time">Start Time:</label>
                                {{ form.start_time(class_="form-control", required="required", oninput="formatTimeInput(this)") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="stop_time">Stop Time:</label>
                                {{ form.stop_time(class_="form-control", required="required", oninput="formatTimeInput(this)") }}
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <div style="display: flex; flex-direction: column;">
                                <label for="description">Description:</label>
                                {{ form.description(class_="form-control", style="min-height: 60px; resize: vertical;") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="job_number">Job #:</label>
                                {{ form.job_number(class_="form-control", maxlength="7") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="mileage">Mileage:</label>
                                {{ form.mileage(class_="form-control") }}
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="location">Location:</label>
                                {{ form.location(class_="form-control") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="billable">Billable:</label>
                                {{ form.billable(class_="form-control") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="pay_rate_rt">Pay Rate RT:</label>
                                {{ form.pay_rate_rt(class_="form-control") }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <label for="pay_rate_ot">Pay Rate OT:</label>
                                {{ form.pay_rate_ot(class_="form-control") }}
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="submit" class="action-btn" style="padding: 10px 20px; text-decoration: none; color: white; margin-top: 10px;">Save Changes</button>
            <a href="{{ url_for('timebooks.timebook_week', employee=timebook.employee) }}" class="action-btn" style="padding: 10px 20px; text-decoration: none; color: white; margin-left: 10px; margin-top: 10px;">Cancel</a>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function formatTimeInput(input) {
            let value = input.value.replace(/[^0-9:]/g, '');
            if (value.length > 5) value = value.slice(0, 5);
            if (value.length >= 2 && value.charAt(2) !== ':') {
                value = value.slice(0, 2) + ':' + value.slice(2);
            }
            if (value.length === 1 && parseInt(value) > 2) value = '0' + value + ':';
            if (value.length === 2 && parseInt(value) < 24) value += ':';
            if (value.length > 3 && parseInt(value.slice(3)) > 59) {
                value = value.slice(0, 3) + '00';
            }
            input.value = value;
        }

        // Future: Disable form if timebook.paid (to be implemented with backend check)
    </script>
{% endblock %}