{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-4">
  <h2>New Purchase Order</h2>

  <form method="POST" class="mt-4">
    {{ form.hidden_tag() }}

    <div class="row g-3 align-items-start border-bottom pb-3 mb-4">
      <!-- VENDOR — NATIVE SEARCHABLE INPUT (WHITE BOX + BOLD BORDER) -->
      <div class="col-md-3">
        <strong>Vendor *</strong><br>
        <div class="position-relative">
          <input type="text" 
                 class="form-control mt-1 vendor-input" 
                 id="vendorSearch" 
                 placeholder="Type to search vendors or select from list..." 
                 autocomplete="off"
                 required>
          <input type="hidden" name="vendor_id" id="vendorId" required>
          <div id="vendorDropdown" 
               class="position-absolute w-100 bg-white border border-dark rounded-bottom shadow" 
               style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
          </div>
        </div>
      </div>

      <!-- JOB # — SIMPLE TEXT INPUT -->
      <div class="col-md-2">
        <strong>Job #</strong><br>
        <input type="text" class="form-control mt-1" id="jobSearch" placeholder="Job # or vessel..." autocomplete="off">
        <input type="hidden" name="job_id" id="jobId">
      </div>

      <!-- CUSTOMER / STOCK — SIMPLE READONLY -->
      <div class="col-md-2">
        <strong>Customer / Stock</strong><br>
        <input type="text" class="form-control mt-1" value="Stock" readonly>
        <input type="hidden" name="customer_id" value="0">
      </div>

      <!-- QUANTITY — SIMPLE INPUT -->
      <div class="col-md-1">
        <strong>Qty</strong><br>
        {{ form.quantity(class="form-control mt-1", placeholder="1") }}
      </div>

      <!-- ITEM DESCRIPTION — TEXTAREA -->
      <div class="col-md-4">
        <strong>Item Description *</strong><br>
        <textarea name="item_description" 
                  class="form-control mt-1" 
                  rows="2" 
                  placeholder="Enter full item description..." 
                  required></textarea>
      </div>
    </div>

    <!-- NOTES -->
    <div class="row mb-4">
      <div class="col-12">
        <strong>Notes / Special Instructions</strong><br>
        {{ form.notes(class="form-control mt-1", rows=3, placeholder="Rush, call when ready, etc.") }}
      </div>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-success btn-lg px-5">Create PO</button>
      <a href="{{ url_for('purchase_orders.purchase_orders_page') }}" class="btn btn-secondary btn-lg px-4 ms-3">Cancel</a>
    </div>
  </form>
</div>

<!-- NATIVE VENDOR SEARCH — NO LIBRARY, 100% RELIABLE -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const vendorInput = document.getElementById('vendorSearch');
  const vendorDropdown = document.getElementById('vendorDropdown');
  const vendorIdInput = document.getElementById('vendorId');
  const vendors = {{ vendors|tojson }};

  vendorInput.addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    vendorDropdown.innerHTML = '';
    vendorDropdown.style.display = 'none';

    if (query.length < 1) return;

    const matches = vendors.filter(v => v.name.toLowerCase().includes(query));
    
    if (matches.length === 0) {
      const div = document.createElement('div');
      div.className = 'p-2 text-muted small';
      div.textContent = 'No vendors found';
      vendorDropdown.appendChild(div);
    } else {
      matches.forEach(v => {
        const div = document.createElement('div');
        div.className = 'p-2 border-bottom hover-light cursor-pointer';
        div.textContent = v.name;
        div.onclick = () => {
          vendorInput.value = v.name;
          vendorIdInput.value = v.id;
          vendorDropdown.innerHTML = '';
          vendorDropdown.style.display = 'none';
        };
        vendorDropdown.appendChild(div);
      });
    }
    vendorDropdown.style.display = 'block';
  });

  // Hide dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!vendorInput.contains(e.target) && !vendorDropdown.contains(e.target)) {
      vendorDropdown.style.display = 'none';
    }
  });
});
</script>

<style>
/* VENDOR INPUT — CLEAN WHITE BOX + BOLD DARK BORDER */
.vendor-input {
  background: white !important;
  border: 2px solid #001f3f !important;
  border-radius: 0.375rem !important;
  min-height: 38px !important;
  padding: 0.375rem 0.75rem !important;
  font-weight: 500 !important;
  color: #212529 !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.vendor-input:focus {
  border-color: #001f3f !important;
  box-shadow: 0 0 0 0.2rem rgba(0, 31, 63, 0.25) !important;
}

.vendor-input::placeholder {
  color: #6c757d !important;
  opacity: 1 !important;
}

/* DROPDOWN — CLEAN WHITE + DARK BORDER */
#vendorDropdown {
  background: white !important;
  border: 2px solid #001f3f !important;
  border-top: none !important;
  border-radius: 0 0 0.375rem 0.375rem !important;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
  z-index: 1050 !important;
}

.hover-light:hover {
  background-color: #f8f9fa !important;
  cursor: pointer !important;
}

.cursor-pointer {
  cursor: pointer !important;
}
</style>
{% endblock %}